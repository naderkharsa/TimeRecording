sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/ui/core/Fragment"],function(t,e,o,n){"use strict";return t.extend("sap.ui.timebookings.controller.Main",{onInit:function(){const t={entry:{start:null,end:null,shortText:"",accountingId:"",accountingText:"",projectId:"",project:""},timer:0,start:false,editMode:false,editContextPath:null};const o=new e(t);o.setDefaultBindingMode(sap.ui.model.BindingMode.TwoWay);this.getView().setModel(o)},_getODataModel:function(){return this.getView().getModel("odataModel")||this.getView().getModel()},_getEntriesBinding:function(){const t=this.byId("entryList");return t.getBinding("items")},onOpenTimePopup:async function(){const t=this.getView().getModel();let e="";let o="";const i=this.byId("projectSelectMain");if(i){e=i.getSelectedKey();o=i.getSelectedItem()?.getText()||""}t.setProperty("/entry",{start:new Date,end:new Date(Date.now()+30*60*1e3),shortText:"",accountingId:"",accountingText:"",projectId:e,project:o});if(!this._oTimeDialog){this._oTimeDialog=await n.load({id:"timeInfoFragment",name:"sap.ui.timebookings.view.fragment.TimeInfoDialog",controller:this});this._oTimeDialog.setModel(t);this.getView().addDependent(this._oTimeDialog)}t.refresh(true);this._oTimeDialog.open();const s=sap.ui.core.Fragment.byId("timeInfoFragment","addBtn");if(s)s.setEnabled(false);this.onDialogInputChange()},onPopupAdd:async function(){const t=this.getView().getModel();const e=t.getProperty("/entry");const n=e.end-e.start;const i=Math.round(n/(1e3*60));const s=Math.floor(i/60);const r=(s>0?s+"h ":"")+i%60+"m";const a={start:e.start.toISOString(),end:e.end.toISOString(),shortText:e.shortText,accountingText:e.accountingText,accountingId:e.accountingId,project:e.project,projectId:e.projectId,duration:r,date:e.start.toISOString().split("T")[0]};try{if(t.getProperty("/editMode")&&this._editCtx){Object.keys(a).forEach(t=>this._editCtx.setProperty(t,a[t]));await this._getODataModel().submitBatch("$auto");o.show("Eintrag aktualisiert");this._editCtx=null;t.setProperty("/editMode",false)}else{const t=this._getEntriesBinding();const e=t.create(a,false);await e.created();o.show(this.getView().getModel("i18n").getResourceBundle().getText("msgTimeSaved"))}const e=this.byId("entryList");if(e){e.getBinding("items").refresh()}}catch(t){o.show("Fehler beim Speichern: "+(t.message||t))}this._oTimeDialog.close();t.setProperty("/entry",{start:null,end:null,shortText:"",accountingId:"",accountingText:"",projectId:"",project:""})},onStartTimer:function(){const t=this.getView().getModel();const e=this.byId("projectSelectMain");const n=e?.getSelectedKey()||"";if(!n){const t=this.getOwnerComponent().getModel("i18n");t.getResourceBundle().then(t=>{o.show(t.getText("msgChooseProject"))});return}t.setProperty("/entry/projectId",n);t.setProperty("/entry/project",e?.getSelectedItem()?.getText()||"");if(!t.getProperty("/start")){this._startTime=new Date;this._timerInterval=setInterval(()=>{t.setProperty("/timer",t.getProperty("/timer")+1)},1e3);t.setProperty("/start",true)}else{clearInterval(this._timerInterval);this._stopTime=new Date;t.setProperty("/start",false);this._openStopDialog()}},_openStopDialog:function(){if(!this._pStopDialog){n.load({id:this.getView().getId(),name:"sap.ui.timebookings.view.fragment.StopDialog",controller:this}).then(t=>{this._pStopDialog=t;this.getView().addDependent(t);t.open();const e=sap.ui.core.Fragment.byId(this.getView().getId(),"okBtn");if(e)e.setEnabled(false)})}else{this._pStopDialog.open();const t=sap.ui.core.Fragment.byId(this.getView().getId(),"okBtn");if(t)t.setEnabled(false)}},onStopConfirm:async function(){const t=this.getView().getModel();const e=t.getProperty("/entry");const n=this.byId("projectSelectMain");const i=n?.getSelectedKey()||e.projectId||"";const s=n?.getSelectedItem()?.getText()||e.project||i;const{start:r,end:a,durationFormatted:c}=this.calculateDuration(this._startTime,this._stopTime);const g={start:r.toISOString(),end:a.toISOString(),shortText:e.shortText,accountingText:e.accountingText,accountingId:e.accountingId,project:s,projectId:i,duration:c,date:r.toISOString().split("T")[0]};try{const t=this._getEntriesBinding();const e=t.create(g,false);await e.created();const n=this.byId("entryList");if(n){n.getBinding("items").refresh()}o.show(this.getView().getModel("i18n").getResourceBundle().getText("msgTimeSaved"))}catch(t){o.show("Fehler beim Speichern: "+(t.message||t))}t.setProperty("/entry",{start:null,end:null,shortText:"",accountingId:"",accountingText:"",projectId:"",project:""});t.setProperty("/timer",0);t.setProperty("/start",false);t.refresh(true);this._pStopDialog.close()},onEditEntry:async function(t){const e=this.getView().getModel();const o=t.getSource().getBindingContext("odataModel");if(!o)return;const i=o.getObject();e.setProperty("/entry",{start:new Date(i.start),end:new Date(i.end),shortText:i.shortText,accountingText:i.accountingText,accountingId:i.accountingId,project:i.project,projectId:i.projectId});e.setProperty("/editMode",true);this._editCtx=o;e.setProperty("/editContextPath",null);if(!this._oTimeDialog){this._oTimeDialog=await n.load({id:"timeInfoFragment",name:"sap.ui.timebookings.view.fragment.TimeInfoDialog",controller:this});this.getView().addDependent(this._oTimeDialog)}this._oTimeDialog.open()},onDeleteEntry:async function(t){const e=t.getSource().getBindingContext("odataModel");if(!e)return;try{await e.delete("$auto");o.show("Eintrag gelöscht")}catch(t){o.show("Löschen fehlgeschlagen: "+(t.message||t))}},onDialogInputChange:function(t){const e=this.getView().getModel();const o=e.getProperty("/entry");if(t&&t.getSource){const o=t.getSource();const n=o.getId?o.getId():"";if(n.includes("shortTextInput")){e.setProperty("/entry/shortText",o.getValue())}if(n.includes("accountingSelect")){e.setProperty("/entry/accountingId",o.getSelectedKey());e.setProperty("/entry/accountingText",o.getSelectedItem()?.getText())}if(n.includes("projectSelect")){e.setProperty("/entry/projectId",o.getSelectedKey());e.setProperty("/entry/project",o.getSelectedItem()?.getText())}}const n=typeof o.shortText==="string"&&o.shortText.trim().length>=5;const i=typeof o.accountingId==="string"&&o.accountingId.trim().length>0;const s=typeof o.projectId==="string"&&o.projectId.trim().length>0;const r=sap.ui.core.Fragment.byId(this.getView().getId(),"okBtn");const a=sap.ui.core.Fragment.byId("timeInfoFragment","addBtn");if(r)r.setEnabled(n&&i);if(a){const t=o.start instanceof Date&&!isNaN(o.start);const e=o.end instanceof Date&&!isNaN(o.end);a.setEnabled(n&&i&&s&&t&&e)}},onPopupCancel:function(){this._oTimeDialog.close()},onStopCancel:function(){this._pStopDialog.close()},formatHours:t=>t!==undefined?String(Math.floor(t/3600)).padStart(2,"0"):"00",formatMinutes:t=>t!==undefined?String(Math.floor(t%3600/60)).padStart(2,"0"):"00",formatSeconds:t=>t!==undefined?String(t%60).padStart(2,"0"):"00",formatButtonType:t=>t?"Negative":"Default",calculateDuration:function(t,e){const o=e-t;const n=Math.round(o/(1e3*60));const i=Math.floor(n/60);const s=n%60;const r=(i>0?i+"h ":"")+s+"m";return{start:t,end:e,durationFormatted:r}},getGroupHeader:function(t){return new sap.m.GroupHeaderListItem({title:"Datum: "+t.key,upperCase:false})}})});
//# sourceMappingURL=Main.controller.js.map